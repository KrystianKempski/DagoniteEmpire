@page "/character"
@using DA_Business.Services
@using Syncfusion.Blazor.Navigations;
@inject ICharacterRepository _characterRepository
@inject IMobRepository _mobRepository
@inject ISpecialSkillRepository _specialSkillRepository
@inject NavigationManager _navigationManager
@inject IUserService _userService;
@inject IJSRuntime _jsRuntime
@inject IDialogService DialogService
@inject IBrowserViewportService _vieportService
@using DialogOptions = MudBlazor.DialogOptions

<_DeleteConfirmation IsParentComponentProcessing=IsLoading DeleteConfirmation="ConfirmDelete_Click" DeletingComponentName="this character"></_DeleteConfirmation>

@if (IsLoading)
{
        <LoadingPage></LoadingPage>
}
else
{
    <div class="page">

        <div class="row mt-4">
            <div class="row p-0">
                <div class="col-12 col-md-8">
                    <h4 class="card-title px-2 mx-2">@Title</h4>
                </div>
                <div class="col-12 col-md-4 p-0">
                    <SfComboBox TValue="int" TItem="CharacterDTO" AllowCustom=true Placeholder="Select your main character" DataSource="@ApprovedCharacters" @bind-Value="CurrentlyUsedCharacterId">
                        <ComboBoxEvents TValue="int" TItem="CharacterDTO" ValueChange="@ValueChangeHandler"></ComboBoxEvents>
                        <ComboBoxFieldSettings Value="Id" Text="NPCName"></ComboBoxFieldSettings>
                    </SfComboBox>
                </div>
            </div>
            
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <SfGrid ID="Grid" DataSource="@Characters" AllowPaging="true"
                        Toolbar="@ToolbarItems">
                    
                    <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" Mode="@EditMode.Dialog"></GridEditSettings>
                    <GridEvents OnActionBegin="ActionHandler" TValue="CharacterDTO"></GridEvents>
                        <GridColumns>
                            @if (UserInfo?.IsAdminOrMG == true){
                                 <GridColumn Field=@nameof(CharacterDTO.UserName) HeaderText="User name" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            }
                            <GridColumn Field=@nameof(CharacterDTO.NPCName) HeaderText="Name" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            <GridColumn Field=@nameof(CharacterDTO.RaceName) HeaderText="Race" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            <GridColumn Field=@nameof(CharacterDTO.ProfessionName) HeaderText="Class" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                        <GridColumn Field=@nameof(CharacterDTO.Age) HeaderText="Age" Format="d" TextAlign="TextAlign.Left" Width="50"></GridColumn>
                        </GridColumns>
                    </SfGrid>
            </div>
        </div>

        @if (UserInfo?.IsAdminOrMG == true)
        {
            <div class="row mt-4">
                <div class="col-12">
                    <SfGrid ID="GridMob" DataSource="@Mobs" AllowPaging="true"
                            Toolbar="@ToolbarItems">

                        <GridEditSettings AllowAdding="true" AllowEditing="true" AllowDeleting="true" Mode="@EditMode.Dialog"></GridEditSettings>
                        <GridEvents OnActionBegin="MobActionHandler" TValue="MobDTO"></GridEvents>
                        <GridColumns>
                            <GridColumn Field=@nameof(MobDTO.Campaign.Name) HeaderText="Campaign" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            <GridColumn Field=@nameof(MobDTO.Name) HeaderText="Name" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            <GridColumn Field=@nameof(MobDTO.RaceName) HeaderText="Race" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                            <GridColumn Field=@nameof(MobDTO.ProfessionName) HeaderText="Class" TextAlign="TextAlign.Left" Width="200"></GridColumn>
                        </GridColumns>
                    </SfGrid>
                </div>
            </div>

        }
    </div>
    
}

@code {
    private IEnumerable<CharacterDTO> Characters { get; set; } = new List<CharacterDTO>();
    private IEnumerable<CharacterDTO> ApprovedCharacters { get; set; } = new List<CharacterDTO>();
    private ICollection<MobDTO> Mobs { get; set; } = new List<MobDTO>();
    public bool IsLoading { get; set; } = true;
    private int DeleteCharacterId { get; set; } = 0;
    private string Title { get; set; } = "Your characters";
    private int CurrentlyUsedCharacterId = 0;


    public UserInfo? UserInfo { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            UserInfo = await _userService.GetUserInfo();
            if (UserInfo?.IsAuthenticated == false)
            {
                var uri = new Uri(_navigationManager.Uri);
                _navigationManager.NavigateTo($"/identity/account/login?returnUrl={uri.LocalPath}",forceLoad:true);
            }
            if(UserInfo?.SelectedCharacterId is not null)
                CurrentlyUsedCharacterId = (int)UserInfo?.SelectedCharacterId;

        }catch(Exception ex)
        {
            IsLoading = false;
            await _jsRuntime.ToastrError("Error while initialize: " + ex.ToString());
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                IsLoading = true;
                StateHasChanged();
                await LoadCharacters();
                await LoadMobs();

                IsLoading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            IsLoading = false;
            await _jsRuntime.ToastrError("Error while initialize: " + ex.ToString());
        }
    }

    private List<object> ToolbarItems = new List<object>() {
        new ItemModel() { Text = "Add Character", PrefixIcon = "e-add", Id = "Grid_add"},//Here Grid is SfGrid ID
        new ItemModel(){ Text = "Edit Character", PrefixIcon= "e-edit", Id="Grid_edit"},
        new ItemModel(){ Text = "Delete Character", PrefixIcon= "e-delete", Id="Grid_delete"},
    };

    private async Task LoadCharacters()
    {

        if(UserInfo is null)
        {
            UserInfo = await _userService.GetUserInfo();
            if (UserInfo is null)
            {
                IsLoading = false;
                await _jsRuntime.ToastrError("Error while initialize user info");
            }
        }

        if (UserInfo is not null && UserInfo?.IsAdminOrMG == true)
        {

            Title = "All avalible characters";
            Characters = await _characterRepository.GetAll();
            ApprovedCharacters = await _characterRepository.GetAllApproved();
        }
        else
        {
            Title = "Characters of " + UserInfo?.UserName;
            Characters = await _characterRepository.GetAllForUser(UserInfo?.UserName);
            ApprovedCharacters = await _characterRepository.GetAllApproved(UserInfo?.UserName);
        }
    }
    private async Task LoadMobs()
    {


        if (UserInfo is not null && UserInfo?.IsAdminOrMG == true)
        {
            Mobs = (await _mobRepository.GetAll()).ToList();
        }
    }

    public void ActionHandler(ActionEventArgs<CharacterDTO> args)
    {
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            _navigationManager.NavigateTo($"/character/create/");
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
        {
            _navigationManager.NavigateTo($"/character/edit/{args.Data.Id}");
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete)){
            HandleDelete(args.RowData.Id);
        }
    }
    public async Task MobActionHandler(ActionEventArgs<MobDTO> args)
    {
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Add))
        {
            MobDTO NewMob = new();
            var parameters = new DialogParameters<CreateMobDialog> {  { x => x.NewMob, NewMob },
                                                                     { x => x.IsEdit, false } };


            var dialog = await DialogService.ShowAsync<CreateMobDialog>("Add Mob", parameters, await SetDialogOptions());
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                NewMob = (MobDTO)result.Data;
                Mobs.Add(NewMob);
            }
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.BeginEdit))
        {
            MobDTO NewMob = args.Data;
            var parameters = new DialogParameters<CreateMobDialog> {  { x => x.NewMob, NewMob },
                                                                     { x => x.IsEdit, true } };


            var dialog = await DialogService.ShowAsync<CreateMobDialog>("Add Mob", parameters, await SetDialogOptions());
            var result = await dialog.Result;

            if (!result.Canceled)
            {
                args.Data = (MobDTO)result.Data;
                Mobs.Add(NewMob);
            }
        }
        else if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete))
        {
            DeleteMob(args.RowData.Id);
        }
    }
    private void DeleteMob(int id)
    {
        
    }

    private void HandleDelete(int id)
    {
        DeleteCharacterId = id;
        _jsRuntime.InvokeVoidAsync("ShowDeleteConfirmationModal");
    }
    public async Task ConfirmDelete_Click(bool isConfirmed)
    {
        IsLoading = true;
        StateHasChanged();
        if (isConfirmed == true && DeleteCharacterId != 0)
        {
            await Task.Delay(500);
            //delete
            var prod = await _characterRepository.GetById(DeleteCharacterId);

            await _characterRepository.Delete(DeleteCharacterId);
            if (CurrentlyUsedCharacterId == DeleteCharacterId)
                _userService.SetSelectedCharId(0);
            await LoadCharacters();
            await _jsRuntime.InvokeVoidAsync("HideDeleteConfirmationModal");
        }
        IsLoading = false;
        StateHasChanged();
    }

    private async Task ValueChangeHandler(ChangeEventArgs<int, CharacterDTO> args)
    {
        CurrentlyUsedCharacterId = args.Value;
        await _userService.SetSelectedCharId(CurrentlyUsedCharacterId);
    }
    private async Task<DialogOptions> SetDialogOptions(MaxWidth maxWidth = MaxWidth.Medium)
    {
        DialogOptions options = new() { MaxWidth = maxWidth };
        if (await _vieportService.GetCurrentBreakpointAsync() <= Breakpoint.Md)
            options.FullScreen = true;
        return options;
    }
}

